{% extends 'contratus/base.html' %}

{% block title %}Nova Proposta - Sistema de Contratos{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-earmark-plus"></i> {{ title }}
            </div>
            <div class="card-body">
                <form method="post" id="propostaForm">
                    {% csrf_token %}
                    
                    <!-- Empreendimento e Unidade -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Empreendimento *</label>
                            {{ form.empreendimento }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Unidade *</label>
                            {{ form.unidade }}
                        </div>
                    </div>

                    <!-- Cliente -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Cliente *</label>
                            {{ form.cliente }}
                            <small class="text-muted">
                                N√£o encontrou? <a href="{% url 'cliente_create' %}" target="_blank">Cadastre um novo cliente</a>
                            </small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- ‚úÖ SE√á√ÉO DE VALORES - NOVOS CAMPOS -->
                    <h5 class="mb-3">
                        <i class="bi bi-calculator"></i> Valores e Parcelamento
                    </h5>

                    <div class="row">
                        <!-- Valor para Construtora -->
                        <div class="col-md-6 mb-3">
                            <label for="id_valor_construtora" class="form-label">
                                Valor para Construtora (sem juros) *
                            </label>
                            {{ form.valor_construtora }}
                            <small class="text-muted d-block">
                                {{ form.valor_construtora.help_text }}
                            </small>
                        </div>

                        <!-- Valor que Cliente Pode Pagar -->
                        <div class="col-md-6 mb-3">
                            <label for="id_valor_parcela_cliente" class="form-label">
                                Valor Mensal que Cliente Pode Pagar *
                            </label>
                            {{ form.valor_parcela_cliente }}
                            <small class="text-muted d-block">
                                {{ form.valor_parcela_cliente.help_text }}
                            </small>
                        </div>
                    </div>

                    <!-- Campos Calculados (edit√°veis) -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>C√°lculo Autom√°tico:</strong> Os campos abaixo s√£o calculados automaticamente, mas voc√™ pode edit√°-los se necess√°rio.
                    </div>

                    <div class="row">
                        <!-- Valor COM Juros -->
                        <div class="col-md-6 mb-3">
                            <label for="id_valor_com_juros" class="form-label">
                                Valor COM Juros (50%)
                            </label>
                            {{ form.valor_com_juros }}
                            <small class="text-muted d-block">
                                {{ form.valor_com_juros.help_text }}
                            </small>
                        </div>

                        <!-- Quantidade de Parcelas -->
                        <div class="col-md-6 mb-3">
                            <label for="id_quantidade_parcelas" class="form-label">
                                N√∫mero de Parcelas
                            </label>
                            {{ form.quantidade_parcelas }}
                            <small class="text-muted d-block">
                                {{ form.quantidade_parcelas.help_text }}
                            </small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Valores de Aprova√ß√£o -->
                    <h5 class="mb-3">
                        <i class="bi bi-cash-stack"></i> Financiamento e Aprova√ß√µes
                    </h5>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Financiamento</label>
                            {{ form.valor_financiamento }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Subs√≠dio</label>
                            {{ form.valor_subsidio }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">FGTS</label>
                            {{ form.valor_fgts }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Valor de Entrada</label>
                            {{ form.valor_entrada }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Total da Aprova√ß√£o</label>
                            <input type="text" class="form-control" id="total_aprovacao_display" readonly style="background-color: #e9ecef;">
                            <small class="text-muted">Financiamento + Subs√≠dio + FGTS</small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Observa√ß√µes -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Observa√ß√µes</label>
                            {{ form.observacoes }}
                        </div>
                    </div>

                    <!-- Bot√µes -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'proposta_list' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-lg"></i> Salvar Proposta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // üîπ Campos principais
    const valorConstrutoraInput = document.getElementById('id_valor_construtora'); // saldo sem juros
    const valorParcelaClienteInput = document.getElementById('id_valor_parcela_cliente');
    const valorComJurosInput = document.getElementById('id_valor_com_juros');
    const quantidadeParcelasInput = document.getElementById('id_quantidade_parcelas');

    // üîπ Campos de aprova√ß√£o
    const financiamentoInput = document.getElementById('id_valor_financiamento');
    const subsidioInput = document.getElementById('id_valor_subsidio');
    const fgtsInput = document.getElementById('id_valor_fgts');
    const entradaInput = document.getElementById('id_valor_entrada');
    const totalAprovacaoDisplay = document.getElementById('total_aprovacao_display');
    const saldoParcelarDisplay = document.getElementById('saldo_parcelar_display'); // voc√™ deve ter esse input/span

    const TAXA_JUROS = 0.5; // 50%

    function formatarMoeda(valor) {
        return 'R$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // üîπ Total de aprova√ß√£o (dinheiro do banco + fgts + subs√≠dio)
    function calcularTotalAprovacao() {
        const financiamento = parseFloat(financiamentoInput.value) || 0;
        const subsidio = parseFloat(subsidioInput.value) || 0;
        const fgts = parseFloat(fgtsInput.value) || 0;

        const total = financiamento + subsidio + fgts;
        totalAprovacaoDisplay.value = formatarMoeda(total);
    }

    // üîπ C√°lculo do parcelamento (l√≥gica correta)
    function calcularParcelamento() {
        const saldoSemJuros = parseFloat(valorConstrutoraInput.value) || 0;
        const valorParcela = parseFloat(valorParcelaClienteInput.value) || 0;

        // Juros
        const valorComJuros = saldoSemJuros * (1 + TAXA_JUROS);
        valorComJurosInput.value = formatarMoeda(valorComJuros);

        // Parcelas
        if (valorParcela > 0) {
            const parcelas = Math.floor(valorComJuros / valorParcela);
            quantidadeParcelasInput.value = parcelas;
        } else {
            quantidadeParcelasInput.value = 0;
        }

        // O saldo a parcelar √â o valor com juros (n√£o subtrai banco de novo)
        if (saldoParcelarDisplay) {
            saldoParcelarDisplay.value = formatarMoeda(valorComJuros);
        }
    }

    // üîπ Eventos
    valorConstrutoraInput.addEventListener('input', calcularParcelamento);
    valorParcelaClienteInput.addEventListener('input', calcularParcelamento);

    financiamentoInput.addEventListener('input', calcularTotalAprovacao);
    subsidioInput.addEventListener('input', calcularTotalAprovacao);
    fgtsInput.addEventListener('input', calcularTotalAprovacao);

    // üîπ Permitir edi√ß√£o manual
    valorComJurosInput.addEventListener('focus', function() {
        this.removeAttribute('readonly');
        this.style.backgroundColor = '#ffffff';
    });

    quantidadeParcelasInput.addEventListener('focus', function() {
        this.removeAttribute('readonly');
        this.style.backgroundColor = '#ffffff';
    });

    // üîπ Inicializa√ß√£o
    calcularParcelamento();
    calcularTotalAprovacao();

    // üîπ Filtro de unidades por empreendimento
    const empreendimentoSelect = document.getElementById('id_empreendimento');
    const unidadeSelect = document.getElementById('id_unidade');

    empreendimentoSelect.addEventListener('change', function() {
        const empreendimentoId = this.value;
        unidadeSelect.innerHTML = '<option value="">---------</option>';

        if (empreendimentoId) {
            fetch(`/ajax/unidades-disponiveis/?empreendimento=${empreendimentoId}`)
                .then(response => response.json())
                .then(data => {
                    data.unidades.forEach(unidade => {
                        const option = new Option(unidade.text, unidade.id);
                        unidadeSelect.add(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar unidades:', error);
                    alert('Erro ao carregar unidades. Tente novamente.');
                });
        }
    });

});
</script>

{% endblock %}
