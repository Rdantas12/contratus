{% extends 'contratus/base.html' %}

{% block title %}{{ title }} - Sistema de Contratos{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-house-door"></i> {{ title }}
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    {{ form.empreendimento }}
    

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Empreendimento:</strong> {{ empreendimento.nome }}
                        <br><small>üí° <strong>Dica:</strong> Escolha um Tipo de Unidade para preencher automaticamente!</small>
                    </div>
                    
                    <h5 class="mb-3">Tipo de Unidade</h5>

<!-- Tipo de Unidade -->
<div class="row">
    <div class="col-md-12 mb-3">
        <label class="form-label">
            Tipo de Unidade (Opcional - Auto-preenche os campos)
        </label>
        {{ form.tipo }}
        {% if form.tipo.errors %}
        <div class="text-danger">{{ form.tipo.errors }}</div>
        {% endif %}
        <small class="text-muted d-block mt-1">
            ‚ú® Ao selecionar um tipo, os campos abaixo ser√£o preenchidos automaticamente!
            <br>Voc√™ ainda pode editar manualmente se necess√°rio.
        </small>
    </div>
</div>

<hr>
<h5 class="mb-3">
    Informa√ß√µes da Unidade
    <span class="badge bg-success ms-2" id="badge-auto-preenchido" style="display: none;">
        Auto-preenchido
    </span>
</h5>

<!-- N√∫mero -->
<div class="row">
    <div class="col-md-4 mb-3">
        <label class="form-label">N√∫mero/Identifica√ß√£o *</label>
        {{ form.numero }}
        {% if form.numero.errors %}
        <div class="text-danger">{{ form.numero.errors }}</div>
        {% endif %}
    </div>
    <div class="col-md-4 mb-3">
        <label class="form-label">Bloco/Torre</label>
        {{ form.bloco }}
    </div>
    <div class="col-md-4 mb-3">
        <label class="form-label">Andar</label>
        {{ form.andar }}
    </div>
</div>

<!-- Caracter√≠sticas -->
<div class="row">
    <div class="col-md-3 mb-3">
        <label class="form-label">√Årea Privativa (m¬≤) *</label>
        {{ form.area_privativa }}
        {% if form.area_privativa.errors %}
        <div class="text-danger">{{ form.area_privativa.errors }}</div>
        {% endif %}
    </div>
    <div class="col-md-3 mb-3">
        <label class="form-label">Quartos *</label>
        {{ form.quartos }}
        {% if form.quartos.errors %}
        <div class="text-danger">{{ form.quartos.errors }}</div>
        {% endif %}
    </div>
    <div class="col-md-3 mb-3">
        <label class="form-label">Su√≠tes *</label>
        {{ form.suites }}
        {% if form.suites.errors %}
        <div class="text-danger">{{ form.suites.errors }}</div>
        {% endif %}
    </div>
    <div class="col-md-3 mb-3">
        <label class="form-label">Banheiros *</label>
        {{ form.banheiros }}
        {% if form.banheiros.errors %}
        <div class="text-danger">{{ form.banheiros.errors }}</div>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-3">
        <label class="form-label">Vagas de Garagem *</label>
        {{ form.vagas_garagem }}
        {% if form.vagas_garagem.errors %}
        <div class="text-danger">{{ form.vagas_garagem.errors }}</div>
        {% endif %}
    </div>
</div>

<hr>
<h5 class="mb-3">Valores</h5>

<div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label">Valor do Im√≥vel (R$) *</label>
        {{ form.valor_imovel }}
        {% if form.valor_imovel.errors %}
        <div class="text-danger">{{ form.valor_imovel.errors }}</div>
        {% endif %}
    </div>
    <div class="col-md-6 mb-3">
        <label class="form-label">Valor de Engenharia (R$) *</label>
        {{ form.valor_engenharia }}
        {% if form.valor_engenharia.errors %}
        <div class="text-danger">{{ form.valor_engenharia.errors }}</div>
        {% endif %}
    </div>
</div>

<hr>
<h5 class="mb-3">Status e Observa√ß√µes</h5>

<div class="row">
    <div class="col-md-4 mb-3">
        <label class="form-label">Status</label>
        {{ form.status }}
    </div>
</div>

<div class="row">
    <div class="col-md-12 mb-3">
        <label class="form-label">Observa√ß√µes</label>
        {{ form.observacoes }}
    </div>
</div>

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'empreendimento_detail' empreendimento.pk %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Salvar Unidade
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// =====================================================
// ‚úÖ AUTO-PREENCHER CAMPOS AO SELECIONAR TIPO
// =====================================================
const tipoSelect = document.getElementById('id_tipo');
const badge = document.getElementById('badge-auto-preenchido');

if (tipoSelect) {
    tipoSelect.addEventListener('change', function() {
        const tipoId = this.value;
        
        if (!tipoId) {
            badge.style.display = 'none';
            return;
        }
        
        // Buscar dados do tipo via API
        fetch(`/api/tipos-unidade/${tipoId}/`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const data = result.data;
                    
                    // ‚úÖ Preencher campos automaticamente
                    document.getElementById('id_area_privativa').value = data.area_util;
                    document.getElementById('id_quartos').value = data.quartos;
                    document.getElementById('id_banheiros').value = data.banheiros;
                    document.getElementById('id_vagas_garagem').value = data.vagas_garagem;
                    document.getElementById('id_valor_imovel').value = data.valor_imovel;
                    document.getElementById('id_valor_engenharia').value = data.valor_engenharia_necessaria;
                    
                    // Su√≠tes (padr√£o 0)
                    document.getElementById('id_suites').value = 0;
                    
                    // ‚úÖ Mostrar badge de confirma√ß√£o
                    badge.style.display = 'inline-block';
                    
                    console.log('‚úÖ Campos preenchidos do tipo:', data.nome);
                }
            })
            .catch(error => {
                console.error('Erro ao buscar tipo:', error);
            });
    });
}
</script>
{% endblock %}
