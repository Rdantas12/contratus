{% extends 'contratus/base.html' %}

{% block title %}{{ title }} - Sistema de Contratos{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning"></i> {{ title }}
            </div>
            <div class="card-body">
                <form method="post" id="form-lote">
                    {% csrf_token %}
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Empreendimento:</strong> {{ empreendimento.nome }}<br>
                        <small>üí° <strong>Dica:</strong> Escolha um Tipo de Unidade para preencher automaticamente os campos!</small>
                    </div>
                    
                    <!-- ============================= -->
                    <!-- HIDDEN: EMPREENDIMENTO -->
                    <!-- ============================= -->
                    {{ form.empreendimento }}
                    
                    <hr>
                    <h5 class="mb-3"><i class="bi bi-tag"></i> Tipo de Unidade</h5>
                    
                    <!-- Tipo de Unidade -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">
                                Tipo de Unidade (Opcional - Auto-preenche os campos abaixo)
                            </label>
                            {{ form.tipo }}
                            {% if form.tipo.errors %}
                            <div class="text-danger">{{ form.tipo.errors }}</div>
                            {% endif %}
                            <small class="text-muted d-block mt-1">
                                ‚ú® Ao selecionar um tipo, os campos de caracter√≠sticas e valores ser√£o preenchidos automaticamente!
                                <br>Voc√™ ainda pode editar os valores manualmente se necess√°rio.
                            </small>
                        </div>
                    </div>
                    
                    <hr>
                    <h5 class="mb-3"><i class="bi bi-123"></i> Numera√ß√£o</h5>
                    
                    <!-- Prefixo e N√∫meros -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Prefixo (opcional)</label>
                            {{ form.prefixo }}
                            <small class="text-muted d-block">
                                Ex: "Casa", "Apto", "Bloco A"
                            </small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">N√∫mero Inicial *</label>
                            {{ form.numero_inicial }}
                            {% if form.numero_inicial.errors %}
                            <div class="text-danger">{{ form.numero_inicial.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">N√∫mero Final *</label>
                            {{ form.numero_final }}
                            {% if form.numero_final.errors %}
                            <div class="text-danger">{{ form.numero_final.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Preview -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="alert alert-secondary" id="preview">
                                <strong>Preview:</strong>
                                <div id="preview-content">Digite os n√∫meros para ver o preview...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Andar e Bloco -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Andar (opcional)</label>
                            {{ form.andar }}
                            <small class="text-muted d-block">
                                Ser√° aplicado a todas as unidades
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Bloco (opcional)</label>
                            {{ form.bloco }}
                            <small class="text-muted d-block">
                                Ser√° aplicado a todas as unidades
                            </small>
                        </div>
                    </div>
                    
                    <hr>
                    <h5 class="mb-3">
                        <i class="bi bi-house-door"></i> Caracter√≠sticas das Unidades
                        <span class="badge bg-success ms-2" id="badge-auto-preenchido" style="display: none;">
                            Auto-preenchido
                        </span>
                    </h5>
                    
                    <!-- √Årea e C√¥modos -->
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">√Årea Privativa (m¬≤) *</label>
                            {{ form.area_privativa }}
                            {% if form.area_privativa.errors %}
                            <div class="text-danger">{{ form.area_privativa.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Quartos *</label>
                            {{ form.quartos }}
                            {% if form.quartos.errors %}
                            <div class="text-danger">{{ form.quartos.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Su√≠tes *</label>
                            {{ form.suites }}
                            {% if form.suites.errors %}
                            <div class="text-danger">{{ form.suites.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Banheiros *</label>
                            {{ form.banheiros }}
                            {% if form.banheiros.errors %}
                            <div class="text-danger">{{ form.banheiros.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Vagas de Garagem *</label>
                            {{ form.vagas_garagem }}
                            {% if form.vagas_garagem.errors %}
                            <div class="text-danger">{{ form.vagas_garagem.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <hr>
                    <h5 class="mb-3">
                        <i class="bi bi-currency-dollar"></i> Valores Financeiros
                        <span class="badge bg-success ms-2" id="badge-auto-preenchido-valores" style="display: none;">
                            Auto-preenchido
                        </span>
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Valor do Im√≥vel (R$) *</label>
                            {{ form.valor_imovel }}
                            {% if form.valor_imovel.errors %}
                            <div class="text-danger">{{ form.valor_imovel.errors }}</div>
                            {% endif %}
                            <small class="text-muted d-block">
                                Valor base de venda de cada unidade
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Valor de Engenharia (R$) *</label>
                            {{ form.valor_engenharia }}
                            {% if form.valor_engenharia.errors %}
                            <div class="text-danger">{{ form.valor_engenharia.errors }}</div>
                            {% endif %}
                            <small class="text-muted d-block">
                                Valor m√≠nimo para aprova√ß√£o de engenharia
                            </small>
                        </div>
                    </div>
                    
                    <hr>
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'empreendimento_detail' empreendimento.pk %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-lightning"></i> Criar Unidades em Lote
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h6><i class="bi bi-lightbulb"></i> Como Funciona</h6>
                <ul class="mb-0 small">
                    <li>‚ú® <strong>Modo Autom√°tico:</strong> Escolha um Tipo de Unidade e os campos ser√£o preenchidos automaticamente</li>
                    <li>‚úèÔ∏è <strong>Modo Manual:</strong> Deixe o tipo em branco e preencha todos os campos manualmente</li>
                    <li>üîß <strong>Personaliza√ß√£o:</strong> Mesmo ap√≥s escolher um tipo, voc√™ pode ajustar qualquer campo</li>
                    <li>üìä <strong>Exemplo:</strong> Tipo "Apartamento 2 Quartos" ‚Üí Cria 10 unidades id√™nticas (101 a 110)</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// =====================================================
// ‚úÖ AUTO-PREENCHER CAMPOS AO SELECIONAR TIPO
// =====================================================
const tipoSelect = document.getElementById('id_tipo');
const badgeCaracteristicas = document.getElementById('badge-auto-preenchido');
const badgeValores = document.getElementById('badge-auto-preenchido-valores');

tipoSelect.addEventListener('change', function() {
    const tipoId = this.value;
    
    if (!tipoId) {
        // Limpar badges se desselecionar
        badgeCaracteristicas.style.display = 'none';
        badgeValores.style.display = 'none';
        return;
    }
    
    // Buscar dados do tipo via API
    fetch(`/api/tipos-unidade/${tipoId}/`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const data = result.data;
                
                // ‚úÖ Preencher campos automaticamente
                document.getElementById('id_area_privativa').value = data.area_util;
                document.getElementById('id_quartos').value = data.quartos;
                document.getElementById('id_banheiros').value = data.banheiros;
                document.getElementById('id_vagas_garagem').value = data.vagas_garagem;
                document.getElementById('id_valor_imovel').value = data.valor_imovel;
                document.getElementById('id_valor_engenharia').value = data.valor_engenharia_necessaria;
                
                // ‚úÖ Preencher su√≠tes (se dispon√≠vel no TipoUnidade)
                // Por enquanto deixa 0 (voc√™ pode adicionar campo suites no TipoUnidade)
                document.getElementById('id_suites').value = 0;
                
                // ‚úÖ Mostrar badges de confirma√ß√£o
                badgeCaracteristicas.style.display = 'inline-block';
                badgeValores.style.display = 'inline-block';
                
                // ‚úÖ Feedback visual (anima√ß√£o)
                [badgeCaracteristicas, badgeValores].forEach(badge => {
                    badge.classList.add('animate__animated', 'animate__pulse');
                    setTimeout(() => {
                        badge.classList.remove('animate__animated', 'animate__pulse');
                    }, 1000);
                });
                
                console.log('‚úÖ Campos preenchidos automaticamente do tipo:', data.nome);
            }
        })
        .catch(error => {
            console.error('Erro ao buscar tipo de unidade:', error);
        });
});

// =====================================================
// PREVIEW DAS UNIDADES
// =====================================================
function atualizarPreview() {
    const prefixo = document.querySelector('input[name="prefixo"]').value;
    const inicial = parseInt(document.querySelector('input[name="numero_inicial"]').value) || 0;
    const final = parseInt(document.querySelector('input[name="numero_final"]').value) || 0;
    
    const previewContent = document.getElementById('preview-content');
    
    if (inicial > 0 && final > 0 && final >= inicial) {
        const quantidade = final - inicial + 1;
        
        if (quantidade > 100) {
            previewContent.innerHTML = '<span class="text-danger">‚ùå M√°ximo de 100 unidades por vez</span>';
            return;
        }
        
        let preview = `<strong>${quantidade} unidade(s) ser√£o criadas:</strong><br><br>`;
        
        // Mostrar primeiras 5
        const max = Math.min(5, quantidade);
        for (let i = 0; i < max; i++) {
            const numero = inicial + i;
            const id = prefixo ? `${prefixo} ${numero.toString().padStart(2, '0')}` : numero.toString().padStart(2, '0');
            preview += `<span class="badge bg-primary me-1 mb-1">${id}</span>`;
        }
        
        if (quantidade > 5) {
            preview += '<span class="badge bg-secondary me-1 mb-1">...</span>';
            
            // Mostrar √∫ltima
            const ultimoNumero = final;
            const ultimoId = prefixo ? `${prefixo} ${ultimoNumero.toString().padStart(2, '0')}` : ultimoNumero.toString().padStart(2, '0');
            preview += `<span class="badge bg-primary me-1 mb-1">${ultimoId}</span>`;
        }
        
        previewContent.innerHTML = preview;
    } else {
        previewContent.innerHTML = 'Digite os n√∫meros para ver o preview...';
    }
}

// Eventos de preview
document.querySelector('input[name="prefixo"]').addEventListener('input', atualizarPreview);
document.querySelector('input[name="numero_inicial"]').addEventListener('input', atualizarPreview);
document.querySelector('input[name="numero_final"]').addEventListener('input', atualizarPreview);

// Preview inicial
atualizarPreview();
</script>

{% if not request.user.is_authenticated or 'animate.css' not in request.META.HTTP_USER_AGENT %}
<!-- Adicionar Animate.css para anima√ß√µes suaves -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endif %}

{% endblock %}
